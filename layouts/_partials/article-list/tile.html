{{- $image := partial "helper/image" (dict "Image" .context.Params.image "Resources" .context.Resources) -}}
{{- $imgMatches := findRE `(?is)<img[^>]+src=["'][^"']+["'][^>]*>` .context.Content 1 -}}
{{- $fallbackSrc := "" -}}
{{- if gt (len $imgMatches) 0 -}}
    {{- $fallbackSrc = replaceRE `(?is).*src=["']([^"']+)["'].*` "$1" (index $imgMatches 0) -}}
{{- end -}}

<article class="{{ if or $image $fallbackSrc }}has-image{{ end }}">
    <a href="{{ .context.RelPermalink }}">
        {{ if or $image $fallbackSrc }}
        <div class="article-image">
            {{ if $image }}
            <img src="{{ $image.Permalink }}" width="{{ $image.Width }}" height="{{ $image.Height }}" loading="lazy" referrerpolicy="no-referrer" alt="Featured image of post {{ .context.Title }}">
            {{ else }}
            <img src="{{ $fallbackSrc }}" loading="lazy" referrerpolicy="no-referrer" alt="Featured image of post {{ .context.Title }}">
            {{ end }}
        </div>
        {{ end }}

        <div class="article-details"
            {{- if and $image $image.Resource -}}
                {{- $colors := $image.Resource.Colors -}}
                {{- if $colors -}}
                    {{- $vibrant := index $colors 0 -}}
                    {{- $darkMuted := index $colors 1 | default $vibrant -}}
                    style="background: linear-gradient(0deg, {{ $darkMuted }}80 0%, {{ $vibrant }}C0 100%);"
                {{- end -}}
            {{- end -}}
        >
            <h2 class="article-title">
                {{- .context.Title -}}
            </h2>
        </div>
    </a>
</article>
