<meta name="referrer" content="no-referrer">
<script>
  (function () {
    var key = "MtimePaletteIndex";
    var saved = localStorage.getItem(key);
    var idx = saved === "0" ? "0" : "1";
    document.documentElement.setAttribute("data-palette", idx);
  })();
</script>
<link rel="stylesheet" href="/css/mtime.css">
<script>
  (function () {
    var paletteKey = "MtimePaletteIndex";

    function setPalette(idx) {
      var next = idx === "1" ? "1" : "0";
      localStorage.setItem(paletteKey, next);
      document.documentElement.setAttribute("data-palette", next);
      var btn = document.getElementById("palette-toggle");
      if (btn) {
        btn.textContent = "配色 " + next;
      }
    }

    function ensurePaletteToggle() {
      if (document.getElementById("palette-toggle")) return;
      var btn = document.createElement("button");
      btn.id = "palette-toggle";
      btn.type = "button";
      btn.textContent = "配色 " + (document.documentElement.getAttribute("data-palette") || "0");
      btn.addEventListener("click", function () {
        var cur = document.documentElement.getAttribute("data-palette") || "0";
        setPalette(cur === "0" ? "1" : "0");
      });
      document.body.appendChild(btn);
    }

    function candidates(src) {
      var list = [];
      if (/\.webp(\?.*)?$/i.test(src)) {
        list.push(src.replace(/\.webp(\?.*)?$/i, ".jpg$1"));
        list.push(src.replace(/\.webp(\?.*)?$/i, ".jpeg$1"));
        list.push(src.replace(/\.webp(\?.*)?$/i, ".png$1"));
      }
      var m = src.match(/^(https:\/\/img)(\d)(\.doubanio\.com\/.*)$/i);
      if (m) {
        for (var i = 1; i <= 9; i++) {
          list.push(m[1] + i + m[3]);
        }
      }
      return list.filter(function (v, i, a) { return v && a.indexOf(v) === i; });
    }

    function bind(img) {
      img.setAttribute("referrerpolicy", "no-referrer");
      img.onerror = function () {
        var idx = Number(img.dataset.fallbackIdx || "0");
        var list = img._fallbackList || candidates(img.currentSrc || img.src);
        img._fallbackList = list;
        if (idx >= list.length) return;
        img.dataset.fallbackIdx = String(idx + 1);
        img.src = list[idx];
      };
    }

    document.addEventListener("DOMContentLoaded", function () {
      setPalette(document.documentElement.getAttribute("data-palette") || "0");
      ensurePaletteToggle();
      document.querySelectorAll("img").forEach(bind);
    });
  })();
</script>
