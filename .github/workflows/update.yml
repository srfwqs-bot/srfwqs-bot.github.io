name: Auto Fetch Douban RSS

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

on:
  schedule:
    - cron: '0 */6 * * *'  # 每 6 小时执行一次
  workflow_dispatch:       # 允许你在 GitHub 网页上点按钮手动执行

jobs:
  update-content:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser

      - name: Validate script syntax
        run: |
          python3 -m py_compile scripts/fetch_douban.py
          python3 -m py_compile scripts/publish_dispatch.py

      - name: Run Fetch Script
        run: python scripts/fetch_douban.py | tee fetch.log

      - name: Build publish queue state
        env:
          PUBLISH_GATEWAY_BASE_URL: ${{ secrets.PUBLISH_GATEWAY_BASE_URL }}
          BAIJIAHAO_PUBLISH_ENDPOINT: ${{ secrets.BAIJIAHAO_PUBLISH_ENDPOINT }}
          BAIJIAHAO_PUBLISH_TOKEN: ${{ secrets.BAIJIAHAO_PUBLISH_TOKEN }}
          TOUTIAO_PUBLISH_ENDPOINT: ${{ secrets.TOUTIAO_PUBLISH_ENDPOINT }}
          TOUTIAO_PUBLISH_TOKEN: ${{ secrets.TOUTIAO_PUBLISH_TOKEN }}
        run: python scripts/publish_dispatch.py | tee -a fetch.log

      - name: Check for changes
        id: changes
        run: |
          git add -A content/posts/ static/posters/ automation/
          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No content changes detected"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Content changes detected"
          fi

      - name: Commit and Push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name 'GitHub Action Bot'
          git config user.email 'action@github.com'
          git commit -m "Auto add new movies from Douban RSS"
          git pull --rebase origin "${GITHUB_REF_NAME}"
          git push origin "HEAD:${GITHUB_REF_NAME}"

      - name: Workflow summary
        if: always()
        run: |
          echo "## Douban Fetch Summary" >> "$GITHUB_STEP_SUMMARY"
          if [ -f fetch.log ]; then
            tail -n 20 fetch.log >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No fetch.log generated" >> "$GITHUB_STEP_SUMMARY"
          fi
